#!/usr/bin/env bash

BIN_NAME=$(basename "$0")
COMMAND_NAME=$1
SUB_COMMAND_NAME=$2

if [ -z "${DOTFILES_DIR:-}" ]; then
  SCRIPT_SOURCE="${BASH_SOURCE[0]:-$0}"
  if command -v readlink >/dev/null 2>&1; then
    while [ -L "$SCRIPT_SOURCE" ]; do
      LINK_TARGET=$(readlink "$SCRIPT_SOURCE")
      if [[ "$LINK_TARGET" == /* ]]; then
        SCRIPT_SOURCE="$LINK_TARGET"
      else
        SCRIPT_SOURCE="$(dirname "$SCRIPT_SOURCE")/$LINK_TARGET"
      fi
    done
  fi
  DOTFILES_DIR=$(cd "$(dirname "$SCRIPT_SOURCE")/.." && pwd)
fi

sub_help () {
  echo "Usage: $BIN_NAME <command>"
  echo
  echo "Commands:"
  echo "   clean            Clean up caches (brew, cargo, gem, pip)"
  echo "   dock             Apply macOS Dock settings"
  echo "   duti             Set default apps for file types (UTI)"
  echo "   edit             Open dotfiles in IDE ($VISUAL) and Git GUI ($VISUAL_GIT)"
  echo "   help             This help message"
  echo "   macos            Apply macOS system defaults"
  echo "   test             Run tests"
  echo "   update           Update packages and pkg managers (brew, casks, cargo, pip3, npm, gems, macOS)"
}

sub_clean () {
  echo "$ brew cleanup"
  brew cleanup
  echo "$ cargo cache --autoclean"
  cargo cache --autoclean
  echo "$ gem cleanup"
  gem cleanup
  echo "$ pip3 cache purge"
  pip3 cache purge
}

sub_dock () {
  . "${DOTFILES_DIR}/macos/dock.sh" && echo "Dock reloaded."
}

sub_edit () {
  sh -c "$VISUAL $DOTFILES_DIR"
  sh -c "$VISUAL_GIT $DOTFILES_DIR"
}

sub_test () {
  bats "$DOTFILES_DIR"/test/*.bats
}

sub_update_mas () {
  local max_attempts=3
  local attempt=1
  local wait_time=5

  if ! command -v mas &> /dev/null; then
    echo "mas not installed, skipping Mac App Store updates"
    return 0
  fi

  echo "Updating Mac App Store apps..."
  echo "Opening App Store..."
  open -a "App Store"
  sleep 2

  while [ $attempt -le $max_attempts ]; do
    echo "Attempt $attempt of $max_attempts..."

    if mas upgrade; then
      echo "Mac App Store apps updated successfully"
      echo "Closing App Store..."
      osascript -e 'quit app "App Store"' 2>/dev/null || true
      return 0
    else
      local exit_code=$?
      echo "mas upgrade failed with exit code $exit_code"

      if [ $attempt -lt $max_attempts ]; then
        echo "Waiting ${wait_time} seconds before retry..."
        sleep $wait_time
        wait_time=$((wait_time * 2))
      fi
    fi

    attempt=$((attempt + 1))
  done

  echo "Warning: mas upgrade failed after $max_attempts attempts, continuing with other updates..."
  echo "Closing App Store..."
  osascript -e 'quit app "App Store"' 2>/dev/null || true
  return 0
}

sub_update () {
  echo "―― Homebrew ―――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――"
  brew update
  brew upgrade
  brew upgrade --cask

  echo "―― Rust (cargo) ――――――――――――――――――――――――――――――――――――――――――――――――――――――――――"
  if command -v cargo &> /dev/null; then
    if command -v cargo-install-update &> /dev/null; then
      cargo install-update -a
    else
      echo "cargo-install-update not found. Install with: cargo install cargo-update"
    fi
  fi

  echo "―― Python (pip3) ――――――――――――――――――――――――――――――――――――――――――――――――――――――――――"
  if command -v pip3 &> /dev/null; then
    pip3 list --outdated --format=json | jq -r '.[] | .name' | xargs -n1 pip3 install -U
  fi

  echo "―― npm ――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――"
  if command -v npm &> /dev/null; then
    npm update -g
  fi

  echo "―― Ruby (gem) ―――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――"
  if command -v gem &> /dev/null; then
    gem update --system
    gem update
  fi

  echo "―― Mac App Store ――――――――――――――――――――――――――――――――――――――――――――――――――――――――"
  sub_update_mas

  echo "―― macOS System ―――――――――――――――――――――――――――――――――――――――――――――――――――――――――"
  softwareupdate -i -a
}

sub_duti () {
  duti -v "${DOTFILES_DIR}/install/duti"
}

sub_macos () {
  for DEFAULTS_FILE in "${DOTFILES_DIR}"/macos/defaults*.sh; do
    echo "Applying ${DEFAULTS_FILE}" && . "${DEFAULTS_FILE}"
  done
  echo "Done. Some changes may require a logout/restart to take effect."
}

case $COMMAND_NAME in
  "" | "-h" | "--help")
    sub_help
    ;;
  *)
    shift
    sub_${COMMAND_NAME} $@
    if [ $? = 127 ]; then
      echo "'$COMMAND_NAME' is not a known command or has errors." >&2
      sub_help
      exit 1
    fi
    ;;
esac
